<!DOCTYPE html>
<html>
  <head>
    <title>Parent Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.4.5.min.js"></script>
    <style>
      #app {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      #chat {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
        margin-bottom: 20px;
      }
      .sent {
        background: #4a90e2;
        color: white;
        padding: 8px;
        margin: 5px;
        border-radius: 4px;
        text-align: right;
      }
      .received {
        background: #f0f0f0;
        padding: 8px;
        margin: 5px;
        border-radius: 4px;
      }
      #controls {
        margin-top: 20px;
      }
      #timeLimit {
        padding: 8px;
        margin-right: 10px;
        width: 100px;
      }
      button {
        padding: 8px 15px;
        background: #4a90e2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #chat-input {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      #messageInput {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="chat"></div>
      <div id="controls">
        <input
          type="number"
          id="timeLimit"
          placeholder="Time limit (minutes)"
        />
        <button onclick="updateTimeLimit()">Set Time</button>
      </div>
    </div>
    <script>
      const pubnub = new PubNub({
        publishKey: "pub-c-cd477f33-cc4d-48e6-821f-4be534286c45",
        subscribeKey: "sub-c-7bdd0761-ffe4-48f3-b891-c487cdd60910",
        userId: "PARENT_USER_ID", // Use a consistent parent ID
      });

      pubnub.subscribe({
        channels: ["parent-child-channel"],
      });

      // Add message handler
      pubnub.addListener({
        message: function (event) {
          if (event.message.type === "CHAT") {
            // Your existing chat code
            const chatDiv = document.getElementById("chat");
            const messageDiv = document.createElement("div");
            messageDiv.textContent = event.message.text;
            messageDiv.className =
              event.publisher === "PARENT_USER_ID" ? "sent" : "received";
            chatDiv.appendChild(messageDiv);
          } else if (
            event.message.type === "NOTIFICATION" &&
            event.message.to === "PARENT_USER_ID"
          ) {
            // Show notification
            new Notification("YouTube Monitor", {
              body: event.message.text,
            });
          }
        },
      });

      // Add chat input UI
      document.getElementById("app").innerHTML += `
  <div id="chat-input">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
  </div>
`;

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (message) {
          pubnub.publish({
            channel: "parent-child-channel",
            message: {
              type: "CHAT",
              text: message,
              timestamp: new Date(),
            },
          });
          input.value = "";
        }
      }

      // After PubNub initialization
      async function setupNotifications() {
        try {
          const permission = await Notification.requestPermission();
          if (permission === "granted") {
            alert("Notifications enabled!");
          }
        } catch (err) {
          alert("Error enabling notifications: " + err);
        }
      }

      // Add button to UI
      const notifyButton = document.createElement("button");
      notifyButton.innerText = "Enable Notifications";
      notifyButton.onclick = setupNotifications;
      document.body.appendChild(notifyButton);

      function updateTimeLimit() {
        const minutes = document.getElementById("timeLimit").value;
        if (minutes > 0) {
          pubnub.publish({
            channel: "parent-child-channel",
            message: {
              type: "TIME_UPDATE",
              timeLimit: minutes * 60 * 1000, // Convert minutes to milliseconds
              from: "PARENT_USER_ID",
              to: "CHILD_USER_ID",
            },
          });
          alert(`Time limit set to ${minutes} minutes`);
        } else {
          alert("Please enter a valid time limit");
        }
      }

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(function (registration) {
            console.log("Service Worker registered");
          })
          .catch(function (error) {
            console.log("Service Worker registration failed:", error);
          });
      }
    </script>
  </body>
</html>
